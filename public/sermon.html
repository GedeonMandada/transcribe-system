<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sermon Player</title>
  <!-- Materialize CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <!-- Google Fonts & Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Custom CSS -->
  <link href="/style.css" rel="stylesheet">
</head>
<body>

  <nav>
    <div class="nav-wrapper">
      <a href="/sermons.html" class="brand-logo"><i class="material-icons">arrow_back</i>Sermon Library</a>
    </div>
  </nav>

  <div class="container">
    <div id="loading-spinner" class="preloader-wrapper big active">
      <div class="spinner-layer spinner-blue-only">
        <div class="circle-clipper left">
          <div class="circle"></div>
        </div><div class="gap-patch">
          <div class="circle"></div>
        </div><div class="circle-clipper right">
          <div class="circle"></div>
        </div>
      </div>
    </div>

    <div id="sermon-content" class="row" style="display: none;">
      <!-- Left Column: Sticky Audio Player -->
      <div class="col s12 l4">
        <div class="audio-player-container card-panel">
          <h4 id="sermon-title" class="center-align"></h4>
          <audio id="audio-player" controls style="width: 100%;"></audio>
          <div class="player-controls center-align">
              <a id="prev-cue-btn" class="btn-floating btn-large waves-effect waves-light"><i class="material-icons">skip_previous</i></a>
              <a id="next-cue-btn" class="btn-floating btn-large waves-effect waves-light"><i class="material-icons">skip_next</i></a>
          </div>
          <div class="divider" style="margin: 20px 0;"></div>
          <div class="highlight-options">
              <h6 class="center-align">Highlighting Options</h6>
              <div class="color-picker-group">
                  <label for="highlight-bg-picker">Background</label>
                  <input type="color" id="highlight-bg-picker" value="#2196F3">
              </div>
              <div class="color-picker-group">
                  <label for="highlight-text-picker">Text</label>
                  <input type="color" id="highlight-text-picker" value="#ffffff">
              </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Transcript -->
      <div class="col s12 l8">
        <div id="transcript-container" class="transcript-container card-panel">
          <p id="transcript-placeholder" class="grey-text">Transcript will appear here...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Materialize JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize Materialize components
      M.AutoInit();

      // DOM Elements
      const sermonTitle = document.getElementById('sermon-title');
      const audioPlayer = document.getElementById('audio-player');
      const transcriptContainer = document.getElementById('transcript-container');
      const loadingSpinner = document.getElementById('loading-spinner');
      const sermonContent = document.getElementById('sermon-content');
      const transcriptPlaceholder = document.getElementById('transcript-placeholder');
      const prevCueBtn = document.getElementById('prev-cue-btn');
      const nextCueBtn = document.getElementById('next-cue-btn');
      const highlightBgPicker = document.getElementById('highlight-bg-picker');
      const highlightTextPicker = document.getElementById('highlight-text-picker');
      const root = document.documentElement;

      let currentHighlightedP = null;
      let textTrack = null;

      // --- Color Picker Logic ---
      highlightBgPicker.addEventListener('input', (e) => {
        root.style.setProperty('--highlight-bg-color', e.target.value);
      });

      highlightTextPicker.addEventListener('input', (e) => {
        root.style.setProperty('--highlight-text-color', e.target.value);
      });

      // --- Fetch and render data ---
      const urlParams = new URLSearchParams(window.location.search);
      const sermonId = urlParams.get('id');

      if (sermonId) {
        fetch(`/api/sermons/${sermonId}`)
          .then(response => {
            if (!response.ok) throw new Error('Sermon not found');
            return response.json();
          })
          .then(sermon => {
            sermonTitle.textContent = sermon.title;
            audioPlayer.src = sermon.audioUrl;

            const trackUrl = `/api/sermons/${sermonId}/vtt`;
            const trackElement = document.createElement('track');
            trackElement.kind = 'subtitles';
            trackElement.label = 'English';
            trackElement.srclang = 'en';
            trackElement.src = trackUrl;
            trackElement.default = true;

            audioPlayer.appendChild(trackElement);

            trackElement.addEventListener('load', () => {
                textTrack = trackElement.track;
                textTrack.mode = 'hidden';

                setTimeout(() => {
                    transcriptPlaceholder.style.display = 'none';
                    let cueCounter = 0;
                    for (const cue of textTrack.cues) {
                        const p = document.createElement('p');
                        p.id = `cue-${cueCounter++}`;
                        p.textContent = cue.text;
                        transcriptContainer.appendChild(p);
                        cue.element = p;
                    }

                    textTrack.addEventListener('cuechange', handleCueChange);
                }, 500);
            });

            loadingSpinner.style.display = 'none';
            sermonContent.style.display = 'flex';
          })
          .catch(error => {
            loadingSpinner.style.display = 'none';
            sermonContent.innerHTML = `<div class="card-panel red lighten-2">Error: ${error.message}</div>`;
            sermonContent.style.display = 'block';
            console.error('Error fetching sermon data:', error);
          });
      }

      // --- Event Handlers ---
      const handleCueChange = () => {
          if (currentHighlightedP) {
              currentHighlightedP.classList.remove('highlight');
          }

          const activeCues = textTrack.activeCues;
          if (activeCues.length > 0) {
              const activeElement = activeCues[0].element;
              activeElement.classList.add('highlight');
              
              const elementRect = activeElement.getBoundingClientRect();
              const containerRect = transcriptContainer.getBoundingClientRect();
              if (elementRect.bottom > containerRect.bottom || elementRect.top < containerRect.top) {
                  activeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }
              currentHighlightedP = activeElement;
          }
      };

      const seek = (direction) => {
          if (!textTrack || !textTrack.activeCues || !textTrack.activeCues[0]) return;
          const currentCue = textTrack.activeCues[0];
          const cues = Array.from(textTrack.cues);
          const currentCueIndex = cues.findIndex(c => c.id === currentCue.id);

          let nextCueIndex;
          if (direction === 'next') {
              nextCueIndex = Math.min(cues.length - 1, currentCueIndex + 1);
          } else {
              nextCueIndex = Math.max(0, currentCueIndex - 1);
          }

          if (nextCueIndex !== currentCueIndex) {
              audioPlayer.currentTime = cues[nextCueIndex].startTime;
          }
      };

      prevCueBtn.addEventListener('click', () => seek('prev'));
      nextCueBtn.addEventListener('click', () => seek('next'));
    });
  </script>
</body>
</html>